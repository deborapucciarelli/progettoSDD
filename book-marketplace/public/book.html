<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dettaglio Libro</title>
  <link rel="stylesheet" href="/css/book.css">
  <link rel="stylesheet" href="/css/navbar.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

  
</head>
<body>

<div id="navbar"></div>
<script src="/js/loadNavbar.js"></script>

<div class="home-container">
  <h1>Dettaglio Libro</h1>
</div>

<div class="books-section" id="bookContainer"></div>

<script>
const contractAddress = "0x358AA13c52544ECCEF6B0ADD0f801012ADAD5eE3";
const contractABI = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "BookAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "BookBought",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "BookRemoved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "msg",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "addr",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Debug",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "isbn",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "addBook",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "books",
		"outputs": [
			{
				"internalType": "string",
				"name": "isbn",
				"type": "string"
			},
			{
				"internalType": "address payable",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "sold",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			}
		],
		"name": "buyBook",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			}
		],
		"name": "getBook",
		"outputs": [
			{
				"internalType": "string",
				"name": "isbn",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "sold",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			}
		],
		"name": "isBookAvailable",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			}
		],
		"name": "removeBook",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];

let currentWallet = localStorage.getItem("walletAddress") || "";

async function connectWallet() {
  if (!window.ethereum) { alert("Installa MetaMask!"); return null; }
  await window.ethereum.request({ method: "eth_requestAccounts" });
  const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = await provider.getSigner();
  const account = await signer.getAddress();
  currentWallet = account;
  localStorage.setItem("walletAddress", currentWallet);
  return { signer, account };
}

async function buyBookOnChain(bookId, priceEth) {
  const { signer } = await connectWallet();
  if (!signer) return;
  const contract = new ethers.Contract(contractAddress, contractABI, signer);
  try {
    const tx = await contract.buyBook(bookId, { value: ethers.parseEther(priceEth) });
    await tx.wait();
    alert("Acquisto completato!");
  } catch(err) {
    console.error(err);
    alert("Errore durante l'acquisto: "+(err.message||err));
  }
}

async function addBookOnChain(book) {
  const { signer, account } = await connectWallet();
  if (!signer) return;

  const contract = new ethers.Contract(contractAddress, contractABI, signer);
  const priceWei = ethers.parseEther(String(book.Prezzo));

  try {
    // aggiungi libro su blockchain
    const tx = await contract.addBook(book._id, book.ISBN, priceWei);
    await tx.wait();

    // salva solo metadati su Mongo
    await fetch('/api/addBook', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(book)
    });

    alert("Libro aggiunto!");
    loadBook();
  } catch(err) {
    console.error(err);
    alert("Errore aggiunta libro: "+(err.message||err));
  }
}

async function loadBook() {
  const bookId = window.location.pathname.split('/').pop();
  const res = await fetch(`/api/books/${bookId}`);
  if (!res.ok) { document.getElementById('bookContainer').innerHTML = '<p>Libro non trovato.</p>'; return; }
  const book = await res.json();

  const bookWallet = (book.User?.wallet_address || "");
  const isOwner = currentWallet && bookWallet && currentWallet === bookWallet;

  const container = document.getElementById('bookContainer');
  container.innerHTML = `
    <div class="book-container">
      <div class="book-image"><img src="${book['Image-URL-S']}" alt="${book['Book-Title']}"></div>
      <div class="book-details">
        <h2>${book['Book-Title']} ${isOwner ? '<span id="deleteBtn" title="Elimina libro">üóëÔ∏è</span>' : ''}</h2>
        <p><strong>Autore:</strong> ${book['Book-Author']}</p>
        <p><strong>Anno:</strong> ${book['Year-Of-Publication']}</p>
        <p><strong>Usato:</strong> ${book.Usato ? 'S√¨' : 'No'}</p>
        <p><strong>Prezzo:</strong> ${book['Prezzo']} ETH</p>
        <p><strong>Utente:</strong> ${book.User?.username || 'N/A'}</p>
        ${!isOwner ? '<button id="buyBtn">Acquista</button>' : ''}
      </div>
    </div>
  `;

  if (!isOwner) {
    document.getElementById("buyBtn").onclick = async () => await buyBookOnChain(book._id, book['Prezzo']);
  }

  if (isOwner) {
    document.getElementById("deleteBtn").onclick = async () => {
      if (!confirm("Sei sicuro di voler eliminare questo libro?")) return;
      try {
        const resDel = await fetch('/api/deleteBook', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'wallet-address': currentWallet },
        body: JSON.stringify({ _id: book._id })
        });
        const data = await resDel.json();
        if (resDel.ok) { alert("Libro eliminato!"); window.location.href='/'; }
        else alert("Errore: "+data.error);
      } catch(err) { console.error(err); alert("Errore cancellazione libro"); }
    };
  }
}

loadBook();
</script>
</body>
</html>
