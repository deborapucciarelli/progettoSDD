<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dettaglio Libro</title>
  <link rel="stylesheet" href="/css/book.css">
  <link rel="stylesheet" href="/css/navbar.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
</head>
<body>

<div id="navbar"></div>
<script src="/js/loadNavbar.js"></script>

<div class="home-container">
  <h1>Dettaglio Libro</h1>
</div>

<div class="books-section" id="bookContainer"></div>

<script>
const contractAddress = "0x5da97b62d7915094756882fb902f959314b4fdd4";
const contractABI = [  
  {
    "anonymous": false,
    "inputs": [
      { "indexed": false, "internalType": "string", "name": "bookId", "type": "string" },
      { "indexed": false, "internalType": "address", "name": "owner", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "price", "type": "uint256" }
    ],
    "name": "BookAdded",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": false, "internalType": "string", "name": "bookId", "type": "string" },
      { "indexed": false, "internalType": "address", "name": "buyer", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
    ],
    "name": "BookBought",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": false, "internalType": "string", "name": "bookId", "type": "string" },
      { "indexed": false, "internalType": "address", "name": "owner", "type": "address" }
    ],
    "name": "BookRemoved",
    "type": "event"
  },
  {
    "inputs": [
      { "internalType": "string", "name": "bookId", "type": "string" },
      { "internalType": "string", "name": "isbn", "type": "string" },
      { "internalType": "uint256", "name": "price", "type": "uint256" }
    ],
    "name": "addBook",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [ { "internalType": "string", "name": "bookId", "type": "string" } ],
    "name": "buyBook",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [ { "internalType": "string", "name": "bookId", "type": "string" } ],
    "name": "getBook",
    "outputs": [
      { "internalType": "string", "name": "isbn", "type": "string" },
      { "internalType": "address", "name": "owner", "type": "address" },
      { "internalType": "uint256", "name": "price", "type": "uint256" },
      { "internalType": "bool", "name": "sold", "type": "bool" }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

let currentWallet = localStorage.getItem("walletAddress") || "";

// üîπ Connetti wallet
async function connectWallet() {
  if (!window.ethereum) { alert("Installa MetaMask!"); return null; }
  await window.ethereum.request({ method: "eth_requestAccounts" });
  const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = await provider.getSigner();
  const account = await signer.getAddress();
  currentWallet = account;
  localStorage.setItem("walletAddress", currentWallet);
  return { signer, account };
}

// üîπ Acquisto libro
async function buyBookOnChain(bookId, priceEth) {
  const { signer } = await connectWallet();
  if (!signer) return;
  const contract = new ethers.Contract(contractAddress, contractABI, signer);

  try {
    // 1. Acquisto su blockchain
    const tx = await contract.buyBook(bookId, { value: ethers.parseEther(priceEth) });
    await tx.wait();

    // 2. Rimuovo libro da MongoDB
    const res = await fetch('/api/buyBook', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ _id: bookId })
    });

    if (!res.ok) {
      const err = await res.json();
      alert("Acquisto registrato su blockchain ma errore DB: " + err.error);
      return;
    }

    // 3. Redirect alla homepage
    alert("Acquisto completato!");
    window.location.href = "/home.html"; // o semplicemente "/" se preferisci

  } catch(err) {
    console.error(err);
    alert("Errore durante l'acquisto: " + (err.message || err));
  }
}

// üîπ Carica libro
async function loadBook() {
  const bookId = window.location.pathname.split('/').pop();
  const res = await fetch(`/api/books/${bookId}`);
  if (!res.ok) {
    document.getElementById('bookContainer').innerHTML = '<p>Libro non trovato.</p>';
    return;
  }
  const book = await res.json();

  const bookWallet = (book.User?.wallet_address || "");
  const isOwner = currentWallet && bookWallet && currentWallet === bookWallet;

  const container = document.getElementById('bookContainer');
  container.innerHTML = `
    <div class="book-container">
      <div class="book-image"><img src="${book['Image-URL-S']}" alt="${book['Book-Title']}"></div>
      <div class="book-details">
        <h2>${book['Book-Title']} ${isOwner ? '<span id="deleteBtn" title="Elimina libro">üóëÔ∏è</span>' : ''}</h2>
        <p><strong>Autore:</strong> ${book['Book-Author']}</p>
        <p><strong>Anno:</strong> ${book['Year-Of-Publication']}</p>
        <p><strong>Usato:</strong> ${book.Usato ? 'S√¨' : 'No'}</p>
        <p><strong>Prezzo:</strong> ${book['Prezzo']} ETH</p>
        <p><strong>Utente:</strong> ${book.User?.username || 'N/A'}</p>
        ${!isOwner ? '<button id="buyBtn">Acquista</button>' : ''}
      </div>
    </div>
  `;

  if (!isOwner) {
    document.getElementById("buyBtn").onclick = async () => await buyBookOnChain(book._id, book['Prezzo']);
  }

  if (isOwner) {
    document.getElementById("deleteBtn").onclick = async () => {
      if (!confirm("Sei sicuro di voler eliminare questo libro?")) return;
      try {
        const resDel = await fetch('/api/deleteBook', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'wallet-address': currentWallet },
          body: JSON.stringify({ _id: book._id })
        });
        const data = await resDel.json();
        if (resDel.ok) { alert("Libro eliminato!"); window.location.href='/'; }
        else alert("Errore: "+data.error);
      } catch(err) { console.error(err); alert("Errore cancellazione libro"); }
    };
  }
}

loadBook();
</script>
</body>
</html>
