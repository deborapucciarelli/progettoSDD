<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dettaglio Libro</title>
  <link rel="stylesheet" href="/css/book.css">
  <link rel="stylesheet" href="/css/navbar.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>

  <style>
    /* Pulsante trash a lato del titolo */
    #deleteBtn {
      display: inline-block;
      margin-left: 10px;
      cursor: pointer;
      font-size: 22px;
      color: #fff8dc; /* colore chiaro, uniforme al titolo */
      transition: transform 0.2s ease, color 0.2s ease;
    }

    #deleteBtn:hover {
      color: #ff5555; /* leggero rosso al passaggio del mouse */
      transform: scale(1.2);
    }

    /* Bottone acquista */
    #buyBtn {
      margin-top: 20px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }

    #buyBtn:hover {
      background: linear-gradient(135deg, #feb47b, #ff7e5f);
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body>

  <div id="navbar"></div>
  <script src="/js/loadNavbar.js"></script>

  <div class="home-container">
    <h1>Dettaglio Libro</h1>
  </div>

  <div class="books-section" id="bookContainer">
    <!-- Dettagli libro verranno inseriti qui -->
  </div>

  <script>
    const currentWallet = (localStorage.getItem("walletAddress") || "").toLowerCase();
    const bookId = window.location.pathname.split('/').pop();

    // Contratto Ethereum
    const contractAddress = "0xf8e81D47203A594245E36C48e151709F0C19fBe8"; // metti qui l'indirizzo del tuo PaymentManagerV2
    const contractABI = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "BookBought",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "books",
		"outputs": [
			{
				"internalType": "string",
				"name": "isbn",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "sold",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "bookId",
				"type": "string"
			}
		],
		"name": "buyBook",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	}
];

    // Funzione per connettere MetaMask
    async function connectWallet() {
      if (!window.ethereum) {
        alert("Installa MetaMask!");
        return null;
      }
      await window.ethereum.request({ method: "eth_requestAccounts" });
      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const account = await signer.getAddress();
      return { provider, signer, account };
    }

    // Funzione per acquistare libro sul contratto
    async function buyBookOnChain(signer, bookId, priceInEther) {
  const contract = new ethers.Contract(contractAddress, contractABI, signer);
  try {
    const tx = await contract.buyBook(bookId, {
      value: ethers.parseEther(priceInEther) // inviamo il prezzo in ETH
    });
    await tx.wait();
    alert("Acquisto completato su blockchain!");
  } catch(err) {
    console.error(err);
    alert("Errore durante l'acquisto: " + (err.message || err));
  }
}


    async function loadBook() {
      try {
        const res = await fetch(`/api/books/${bookId}`);
        if (!res.ok) {
          document.getElementById('bookContainer').innerHTML = '<p>Libro non trovato.</p>';
          return;
        }
        const book = await res.json();

        const bookWallet = (book.User?.wallet_address || "").toLowerCase();
        const isOwner = currentWallet && bookWallet && currentWallet === bookWallet;

        const container = document.getElementById('bookContainer');
        container.innerHTML = `
          <div class="book-container">
            <div class="book-image">
              <img src="${book['Image-URL-S']}" alt="${book['Book-Title']}">
            </div>
            <div class="book-details">
              <h2>
                ${book['Book-Title']}
                ${isOwner ? '<span id="deleteBtn" title="Elimina libro">üóëÔ∏è</span>' : ''}
              </h2>
              <p><strong>Autore:</strong> ${book['Book-Author']}</p>
              <p><strong>Anno:</strong> ${book['Year-Of-Publication']}</p>
              <p><strong>Usato:</strong> ${book.Usato ? 'S√¨' : 'No'}</p>
              <p><strong>Prezzo:</strong> ${book['Prezzo']}</p>
              <p><strong>Utente:</strong> ${book.User?.username || 'N/A'}</p>

              <button id="buyBtn">Acquista</button>
            </div>
          </div>
        `;

        // Bottone acquista
        document.getElementById("buyBtn").onclick = async () => {
       if (!bookWallet) {
          alert("Indirizzo del venditore non disponibile.");
      return;
      }
      const { signer } = await connectWallet();
    if (!signer) return;
      // book['Prezzo'] deve essere una stringa in ETH
    await buyBookOnChain(signer, bookId, book['Prezzo']);
    };


        // Bottone elimina (solo se owner)
        if (isOwner) {
          document.getElementById("deleteBtn").onclick = async () => {
            if (!confirm("Sei sicuro di voler eliminare questo libro?")) return;
            try {
              const resDel = await fetch('/api/deleteBook', {
                method: 'DELETE',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ _id: book._id })
              });
              const data = await resDel.json();
              if (resDel.ok) {
                alert("Libro eliminato con successo!");
                window.location.href = '/utente/' + currentWallet + '?wallet=' + currentWallet;
              } else {
                alert("Errore: " + data.error);
              }
            } catch(err) {
              console.error("Errore deleteBook:", err);
              alert("Errore nella cancellazione del libro.");
            }
          };
        }

      } catch (err) {
        console.error("Errore loadBook:", err);
        document.getElementById('bookContainer').innerHTML = '<p>Errore caricamento libro.</p>';
      }
    }

    loadBook();
  </script>
</body>
</html>